@page "/accounts"
@using System.Threading;
@inject IAccountService AccountService
@implements IDisposable

<h3>Alla konton</h3>

@if (!_isUnlocked)
{
    <!-- PIN lock UI -->
    <div class="pin-lock">
        <p>Ange PIN för att komma åt konton:</p>
        <input @bind="_pinInput" type="password"/>
        <button @onclick="UnlockAccounts">Lås upp</button>
        @if (!string.IsNullOrEmpty(_pinMessage))
        {
            <p style="color:red">@_pinMessage</p>
        }
    </div>
}
else if (_accounts == null)
{
    <p>Laddar konton...</p>
}
else if (!_accounts.Any())
{
    <p>Inga konton hittades.</p>
}
else
{
    <table class="table table-striped">
        <thead>
        <tr>
            <th style="width:200px;">Kontonamn</th>
            <th style="width:150px;">Kontotyp</th>
            <th style="width:120px;">Saldo</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var account in _accounts)
        {
            <tr>
                <td>@account.Name</td>
                <td>@GetAccountTypeDisplay(account.AccountType)</td>
                <td>@account.Balance.ToString("C")</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {

    // PIN code lock variables
    private string _pinInput = ""; // Holds the user input for PIN
    private const string _correctPin = "1234"; // Hardcoded correct PIN
    private bool _isUnlocked = false; // Tracks if accounts are unlocked
    private string _pinMessage = ""; // Message shown for incorrect PIN

    /// <summary>
    /// Holds the list of accounts retrieved from the account service.
    /// </summary>
    private List<IBankAccount> _accounts;

    /// <summary>
    /// Timer that applies interest to savings accounts every minute.
    /// If any balances change, the updated accounts are saved and the UI is refreshed.
    /// </summary>
    private Timer? _timer;

    /// <summary>
    /// Called when the component is initialized.
    /// Fetches all accounts from AccountService and sets up a timer that applies interest
    /// to savings accounts every minute. If any balances change, the updates are saved
    /// and the UI is refreshed.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        _accounts = await AccountService.GetAccounts();

        // Initialize timer to run ApplyInterest every minute
        _timer = new Timer(async _ =>
        {
            bool anyChanged = false;

            // Loop through all accounts that are of type BankAccount
            foreach (var account in _accounts.OfType<BankAccount>())
            {
                decimal oldBalance = account.Balance;

                // Apply interest if applicable
                account.ApplyInterest();

                // Check if balance has changed
                if (account.Balance != oldBalance)
                    anyChanged = true;
            }

            // If any account balance changed, save accounts and refresh UI
            if (anyChanged)
            {
                await AccountService.SaveAccounts();
                await InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));
    }

    /// <summary>
    /// Disposes the timer when the component is destroyed to prevent memory leaks.
    /// </summary>
    public void Dispose()
    {
        _timer?.Dispose();
    }

    /// <summary>
    /// Returns a localized, user-friendly display name for an <see cref="AccountType"/> value.
    /// </summary>
    /// <param name="type">The account type to translate.</param>
    /// <returns>A Swedish string representing the account type.</returns>
    private string GetAccountTypeDisplay(AccountType type)
    {
        return type switch
        {
            AccountType.Savings => "Sparkonto", // Savings account
            AccountType.Deposit => "Lönekonto", // Salary account
            AccountType.Unknown => "Okänt konto", // Unknown account.
            _ => "Okänt konto"
        };
    }

    /// <summary>
    /// Attempts to unlock the accounts view using the entered PIN code.
    /// If the entered PIN matches the correct PIN, the accounts are unlocked.
    /// Otherwise, an error message is displayed and the input is cleared.
    /// </summary>
    private void UnlockAccounts()
    {
        if (_pinInput == _correctPin)
        {
            _isUnlocked = true;
            _pinMessage = "";
        }
        else
        {
            _pinMessage = "Fel PIN. Försök igen.";
            _pinInput = "";
        }
    }

}